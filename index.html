<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Infinity N5 - Intelligenza Tattica v7</title>
    <style>
        body { font-family: Arial, sans-serif; background-color: #1e2124; color: #ffffff; padding: 20px; max-width: 500px; margin: 0 auto; }
        h2 { text-align: center; color: #00ffaa; margin-bottom: 0; }
        .version { text-align: center; color: #00d2ff; font-size: 14px; font-weight: bold; margin-bottom: 20px; }
        
        #setupScreen, #mainScreen { background-color: #2c2f33; padding: 20px; border-radius: 8px; border: 1px solid #444; }
        .form-group { margin-bottom: 15px; }
        label { display: block; font-size: 13px; color: #aaa; margin-bottom: 5px; }
        select { width: 100%; padding: 10px; background-color: #1a1c1e; color: #fff; border: 1px solid #555; border-radius: 4px; font-size: 14px; }
        
        button { width: 100%; padding: 15px; border: none; border-radius: 4px; font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.2s; margin-top: 10px; }
        .btn-primary { background-color: #00d2ff; color: #000; }
        .btn-active { background-color: #00ffaa; color: #000; }
        .btn-reactive { background-color: #ffaa00; color: #000; }
        .btn-reset { background-color: #ff3366; color: #fff; margin-top: 20px;}
        button.recording { opacity: 0.8; animation: pulse 1s infinite; background-color: #ff3366 !important; color: white !important;}

        .player-panel { display: flex; gap: 10px; margin-bottom: 10px; }
        .player-panel button { margin-top: 0; }

        .encounter-board { margin-top: 20px; border-top: 2px dashed #555; padding-top: 15px; }
        .active-card { background-color: rgba(0, 255, 170, 0.1); border-left: 4px solid #00ffaa; padding: 12px; margin-bottom: 10px; border-radius: 4px; }
        .aro-card { background-color: rgba(255, 170, 0, 0.1); border-left: 4px solid #ffaa00; padding: 12px; margin-bottom: 10px; border-radius: 4px; }
        
        .action-title { font-weight: bold; font-size: 16px; margin: 0 0 5px 0; }
        .action-desc { font-size: 13px; color: #ccc; margin: 0 0 8px 0; font-style: italic; }
        
        .error-tag { background-color: #ff3366; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; display: inline-block; margin-top: 5px; }
        .success-tag { background-color: #00cc88; color: black; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; display: inline-block; margin-top: 5px; }

        .tactical-data { display: flex; justify-content: space-between; background-color: #1a1c1e; padding: 8px; border-radius: 4px; border: 1px solid #555; margin-top: 8px; }
        .t-input { width: 40px; padding: 4px; text-align: center; background-color: #2c2f33; color: #fff; border: 1px solid #00ffaa; border-radius: 4px; }
        
        .status { text-align: center; font-size: 12px; color: #888; margin-top: 20px; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(0.98); } 100% { transform: scale(1); } }
    </style>
</head>
<body>

    <h2>Terminale Tattico N5</h2>
    <div class="version">Versione 7.0 - Arbitro Vocale e Validazione</div>

    <div id="setupScreen">
        <h3 style="margin-top:0; text-align:center;">Caricamento Liste</h3>
        <p style="font-size: 13px; color: #ccc; text-align: center;">Seleziona le fazioni. L'IA convalider√† gli ordini in base ai profili di queste squadre.</p>
        <div class="form-group">
            <label>Giocatore 1 (Attivo)</label>
            <select id="team1Select"></select>
        </div>
        <div class="form-group">
            <label>Giocatore 2 (Reattivo)</label>
            <select id="team2Select"></select>
        </div>
        <button class="btn-primary" onclick="avviaPartita()">Sincronizza Liste e Inizia üöÄ</button>
    </div>

    <div id="mainScreen" style="display: none;">
        
        <div class="player-panel">
            <button id="btnVoice" class="btn-active">üé§ Ordine (G1)</button>
            <button id="btnAro" class="btn-reactive">üõ°Ô∏è ARO (G2)</button>
        </div>

        <div id="board" class="encounter-board" style="display: none;">
            <div id="activeActionArea"></div>
            <div id="aroListArea"></div>
            <button id="btnReset" class="btn-reset" onclick="resetBoard()">üîÑ Risolvi e Pulisci Tavolo</button>
        </div>
    </div>

    <div class="status" id="dbStatus">Connessione a Firebase in corso...</div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

        // FIREBASE CONFIG (Pronto per il DB reale)
        const firebaseConfig = {
            apiKey: "AIzaSyAMpF8Le_srYjxgC7vb231Ng40iXwr256o",
            authDomain: "infinityn5-database.firebaseapp.com",
            projectId: "infinityn5-database",
            storageBucket: "infinityn5-database.firebasestorage.app",
            messagingSenderId: "506923243459",
            appId: "1:506923243459:web:4aa5e59c84c9d8156c4f76"
        };
        initializeApp(firebaseConfig);
        document.getElementById('dbStatus').innerText = "‚úÖ Arbitro IA Connesso";
        document.getElementById('dbStatus').style.color = "#00ffaa";

        // ==========================================
        // ROSTER SIMULATO (Sar√† sostituito da Firebase)
        // ==========================================
        const databaseSquadre = {
            "PanOceania": {
                "fusilier": ["combi rifle", "pistol", "cc weapon"],
                "orc troop": ["multi rifle", "heavy pistol", "cc weapon"],
                "aquila guard": ["hmg", "shock marksman rifle", "pistol"]
            },
            "Nomads": {
                "alguacil": ["combi rifle", "pistol", "cc weapon"],
                "moran": ["boarding shotgun", "combi rifle", "flash pulse"],
                "mobile brigada": ["multi rifle", "light flamethrower", "pistol"]
            }
        };

        // Dizionario di tutte le armi per riconoscerle nella frase anche se sbagliate
        const tutteLeArmi = ["combi rifle", "multi rifle", "hmg", "shock marksman rifle", "boarding shotgun", "flash pulse", "light flamethrower", "pistol", "heavy pistol", "cc weapon"];

        const fazioni = Object.keys(databaseSquadre);
        const selT1 = document.getElementById('team1Select');
        const selT2 = document.getElementById('team2Select');
        fazioni.forEach(f => { selT1.add(new Option(f, f)); selT2.add(new Option(f, f)); });
        selT2.selectedIndex = 1;

        let fazioneAttiva = "";
        let fazioneReattiva = "";

        window.avviaPartita = function() {
            fazioneAttiva = document.getElementById('team1Select').value;
            fazioneReattiva = document.getElementById('team2Select').value;
            document.getElementById('setupScreen').style.display = "none";
            document.getElementById('mainScreen').style.display = "block";
        };

        window.poolScontro = { 
            azioneAttiva: null,
            bersagliAro: [] 
        };

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition;
        let modalitaCorrente = 'active';

        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.lang = 'it-IT';
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;

            recognition.onstart = function() {
                let btn = modalitaCorrente === 'active' ? document.getElementById('btnVoice') : document.getElementById('btnAro');
                btn.classList.add('recording'); btn.innerText = "Ascolto in corso...";
            };
            recognition.onspeechend = function() { recognition.stop(); };
            
            recognition.onresult = function(event) {
                ripristinaBottoni();
                const trascrizione = event.results[0][0].transcript.toLowerCase();
                elaboraComandoVocale(trascrizione, modalitaCorrente);
                aggiornaInterfaccia();
            };
            recognition.onerror = function() { ripristinaBottoni(); };

            document.getElementById('btnVoice').addEventListener('click', () => { modalitaCorrente = 'active'; recognition.start(); });
            document.getElementById('btnAro').addEventListener('click', () => { modalitaCorrente = 'reactive'; recognition.start(); });
        }

        function ripristinaBottoni() {
            const btnV = document.getElementById('btnVoice'); btnV.classList.remove('recording'); btnV.innerHTML = "üé§ Ordine (G1)";
            const btnA = document.getElementById('btnAro'); btnA.classList.remove('recording'); btnA.innerHTML = "üõ°Ô∏è ARO (G2)";
        }

        function estraiDatiTattici(testo) {
            let dadi = 1; let dist = 0;
            const mapNumeri = { "un": 1, "uno": 1, "due": 2, "tre": 3, "quattro": 4, "cinque": 5 };
            let testoNorm = testo;
            for (let [word, num] of Object.entries(mapNumeri)) testoNorm = testoNorm.replace(new RegExp(`\\b${word}\\b`, 'g'), num);
            let matchDadi = testoNorm.match(/(\d+)\s*(dadi|dado|colpi|colpo)/); if (matchDadi) dadi = parseInt(matchDadi[1]);
            let matchDist = testoNorm.match(/(\d+)\s*(pollici|inch)/) || testoNorm.match(/(distanza|entro|a)\s*(\d+)/); if (matchDist) dist = parseInt(matchDist[2] || matchDist[1]);
            return { dadi, dist };
        }

        // ==========================================
        // CUORE DELL'ARBITRO IA: VALIDAZIONE
        // ==========================================
        function validaEntita(testo, fazione) {
            let truppaTrovata = "Sconosciuto";
            let armaTrovata = "Nessuna Arma Specifica";
            let errori = [];

            const roster = databaseSquadre[fazione];
            const nomiTruppe = Object.keys(roster);

            // 1. Cerca la truppa nella frase
            for (let t of nomiTruppe) {
                if (testo.includes(t)) { truppaTrovata = t; break; }
            }

            if (truppaTrovata === "Sconosciuto") {
                errori.push(`Unit√† non trovata nel roster ${fazione}.`);
            } else {
                // 2. Cerca un'arma qualsiasi nella frase
                let armaNellaFrase = null;
                for (let w of tutteLeArmi) {
                    if (testo.includes(w)) { armaNellaFrase = w; break; }
                }

                if (armaNellaFrase) {
                    // 3. Controlla se la truppa ha quell'arma
                    if (roster[truppaTrovata].includes(armaNellaFrase)) {
                        armaTrovata = armaNellaFrase;
                    } else {
                        armaTrovata = armaNellaFrase;
                        errori.push(`Il ${truppaTrovata.toUpperCase()} non ha ${armaNellaFrase.toUpperCase()} in dotazione!`);
                    }
                }
            }

            return { truppa: truppaTrovata, arma: armaTrovata, errori: errori };
        }

        function elaboraComandoVocale(testo, mode) {
            const fazione = mode === 'active' ? fazioneAttiva : fazioneReattiva;
            
            // Estrazione Skill base
            const paroleChiave = { "muovo": "Move", "muove": "Move", "sparo": "BS Attack", "spara": "BS Attack", "schiva": "Dodge", "schivo": "Dodge", "scopro": "Discover", "hacker": "Hacking", "corpo": "CC Attack" };
            let skill = "Azione Non Riconosciuta";
            for (const [parola, s] of Object.entries(paroleChiave)) if (testo.includes(parola)) { skill = s; break; }

            // Validazione Roster
            const check = validaEntita(testo, fazione);
            const dati = estraiDatiTattici(testo);

            const pacchettoAzione = {
                skillBase: mode === 'active' ? skill : skill + " (ARO)",
                testoOriginale: testo,
                unita: check.truppa.toUpperCase(),
                arma: check.arma.toUpperCase(),
                errori: check.errori,
                dadi: dati.dadi,
                distanza: dati.distanza
            };

            if (mode === 'active') {
                window.poolScontro.azioneAttiva = pacchettoAzione;
                window.poolScontro.bersagliAro = [];
            } else {
                window.poolScontro.bersagliAro.push(pacchettoAzione);
            }
        }

        window.aggiornaInterfaccia = function() {
            document.getElementById('board').style.display = "block";
            
            // Render Azione Attiva
            let htmlAttivo = "";
            if (window.poolScontro.azioneAttiva) {
                let act = window.poolScontro.azioneAttiva;
                let tags = "";
                if (act.errori.length > 0) {
                    act.errori.forEach(e => tags += `<div class="error-tag">‚ùå ILLEGALE: ${e}</div><br>`);
                } else {
                    tags = `<div class="success-tag">‚úÖ Profilo Convalidato</div>`;
                }

                htmlAttivo = `
                    <div class="active-card">
                        <p class="action-title" style="color:#00ffaa;">üü¢ ${act.unita} | Arma: ${act.arma}</p>
                        <p class="action-desc">Ordine: ${act.skillBase} - "${act.testoOriginale}"</p>
                        ${tags}
                    </div>
                `;
            }
            document.getElementById('activeActionArea').innerHTML = htmlAttivo;

            // Render ARO
            let htmlAro = "";
            window.poolScontro.bersagliAro.forEach((aro, i) => {
                let tags = "";
                if (aro.errori.length > 0) {
                    aro.errori.forEach(e => tags += `<div class="error-tag">‚ùå ILLEGALE: ${e}</div><br>`);
                }

                htmlAro += `
                    <div class="aro-card">
                        <p class="action-title" style="color:#ffaa00;">üõ°Ô∏è ARO ${i+1}: ${aro.unita} | Arma: ${aro.arma}</p>
                        <p class="action-desc">${aro.skillBase} - "${aro.testoOriginale}"</p>
                        ${tags}
                        <div class="tactical-data">
                            <span style="font-size:12px; color:#ccc;">Pollici: <input type="number" class="t-input" style="border-color:#00d2ff;" value="${aro.distanza||''}"></span>
                            <span style="font-size:12px; color:#ccc;">Dadi vs Lui: <input type="number" class="t-input" value="${aro.dadi}"></span>
                        </div>
                    </div>
                `;
            });
            document.getElementById('aroListArea').innerHTML = htmlAro;
        }

        window.resetBoard = function() {
            window.poolScontro = { azioneAttiva: null, bersagliAro: [] };
            document.getElementById('board').style.display = "none";
        }
    </script>
</body>
</html>
